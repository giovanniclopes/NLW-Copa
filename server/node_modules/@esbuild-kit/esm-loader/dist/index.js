import _ from"path";import{fileURLToPath as h,pathToFileURL as R}from"url";import{installSourceMapSupport as F,compareNodeVersion as g,resolveTsPath as U,transform as E,transformDynamicImport as P}from"@esbuild-kit/core-utils";import{parseTsconfig as I,getTsconfig as J,createPathsMatcher as W}from"get-tsconfig";import T from"fs";const m=new Map;async function D(t){if(m.has(t))return m.get(t);if(!await T.promises.access(t).then(()=>!0,()=>!1)){m.set(t,void 0);return}const n=await T.promises.readFile(t,"utf8");try{const o=JSON.parse(n);return m.set(t,o),o}catch{throw new Error(`Error parsing: ${t}`)}}async function v(t){let s=new URL("package.json",t);for(;!s.pathname.endsWith("/node_modules/package.json");){const n=h(s),o=await D(n);if(o)return o;const r=s;if(s=new URL("../package.json",s),s.pathname===r.pathname)break}}async function A(t){var s;const n=await v(t);return(s=n==null?void 0:n.type)!=null?s:"commonjs"}const p=F(),f=process.env.ESBK_TSCONFIG_PATH?{path:process.env.ESBK_TSCONFIG_PATH,config:I(process.env.ESBK_TSCONFIG_PATH)}:J(),k=f==null?void 0:f.config,l=f&&W(f),w="file://",u=/\.([cm]?ts|[tj]sx)$/,L=t=>{const s=_.extname(t);if(s===".json")return"json";if(s===".mjs"||s===".mts")return"module";if(s===".cjs"||s===".cts")return"commonjs"},S=t=>{const s=L(t);if(s)return s;if(u.test(t))return A(t)},M=[".js",".json",".ts",".tsx",".jsx"];async function j(t,s,n){let o;for(const r of M)try{return await d(t+r,s,n,!0)}catch(a){if(o===void 0){const{message:e}=a;a.message=a.message.replace(`${r}'`,"'"),a.stack=a.stack.replace(e,a.message),o=a}}throw o}async function N(t,s,n){const o=t.endsWith("/")?"index":"/index";try{return await j(t+o,s,n)}catch(r){const{message:a}=r;throw r.message=r.message.replace(`${o.replace("/",_.sep)}'`,"'"),r.stack=r.stack.replace(a,r.message),r}}const x=/^\.{0,2}\//,C=g([14,13,1])>=0||g([12,20,0])>=0,d=async function(t,s,n,o){var r;if(!C&&t.startsWith("node:")&&(t=t.slice(5)),t.endsWith("/"))return await N(t,s,n);const a=t.startsWith(w)||x.test(t);if(l&&!a&&!((r=s.parentURL)!=null&&r.includes("/node_modules/"))){const c=l(t);for(const i of c)try{return await d(R(i).toString(),s,n)}catch{}}if(u.test(s.parentURL)){const c=U(t);if(c)try{return await d(c,s,n,!0)}catch(i){const{code:y}=i;if(y!=="ERR_MODULE_NOT_FOUND"&&y!=="ERR_PACKAGE_PATH_NOT_EXPORTED")throw i}}let e;try{e=await n(t,s,n)}catch(c){if(c instanceof Error&&!o){if(c.code==="ERR_UNSUPPORTED_DIR_IMPORT")return await N(t,s,n);if(c.code==="ERR_MODULE_NOT_FOUND")return await j(t,s,n)}throw c}return!e.format&&e.url.startsWith(w)&&(e.format=await S(e.url)),e},K=async function(t,s,n){process.send&&process.send({type:"dependency",path:t}),t.endsWith(".json")&&(s.importAssertions||(s.importAssertions={}),s.importAssertions.type="json");const o=await n(t,s,n);if(!o.source)return o;const r=h(t),a=o.source.toString();if(o.format==="json"||u.test(t)){const e=await E(a,r,{tsconfigRaw:k});return{format:"module",source:p(e,t)}}if(o.format==="module"){const e=P(r,a);e&&(o.source=p(e,t))}return o},b=async function(t,s,n){if(t.endsWith(".json"))return{format:"module"};try{return await n(t,s,n)}catch(o){if(o.code==="ERR_UNKNOWN_FILE_EXTENSION"&&t.startsWith(w)){const r=await S(t);if(r)return{format:r}}throw o}},H=async function(t,s,n){const{url:o}=s,r=h(o);if(process.send&&process.send({type:"dependency",path:o}),o.endsWith(".json")||u.test(o)){const e=await E(t.toString(),r,{tsconfigRaw:k});return{source:p(e,o)}}const a=await n(t,s,n);if(s.format==="module"){const e=P(r,a.source.toString());e&&(a.source=p(e,o))}return a},O=g([16,12,0])<0,$=O?b:void 0,B=O?H:void 0;export{$ as getFormat,K as load,d as resolve,B as transformSource};
